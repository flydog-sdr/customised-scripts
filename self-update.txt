#!/bin/bash

# SCRIPT_ID variable for self-update
SCRIPT_ID=3c174aea

# check if Auto-update is enabled
if [ $(cat /etc/kiwi.config/_UPDATE) -eq 1 ]; then
    echo "Auto-update is enabled, will now check for update."
else
    echo "Auto-update is disabled, exiting."
    exit 0
fi

# Check internet connectivity
NETWORK_CHECK_URL="1.0.0.1"
NETWORK_CHECK_RESPONSE="301"
if [ $(curl -I -s --connect-timeout 15 --retry 10 ${NETWORK_CHECK_URL} -w %{http_code} | tail -n1) -eq ${NETWORK_CHECK_RESPONSE} ]; then
    echo "Internet connected, continue."
else
    echo "Internet not connected, exiting."
    exit 1
fi

# Fetch IP from DoH
GITHUB_RWA_IP="$(curl -H 'accept: application/dns-json' -s --connect-timeout 15 --retry 10 'https://1.0.0.1/dns-query?name=raw.githubusercontent.com&type=A' | jq -r '.Answer[1].data')"
GITHUB_CODELOAD_IP="$(curl -H 'accept: application/dns-json' -s --connect-timeout 15 --retry 10 'https://1.0.0.1/dns-query?name=codeload.github.com&type=A' | jq -r '.Answer[0].data')"

# Define global environment variables
APP_NAME="flydog-sdr"
CURL_ARGS="-L -s --connect-timeout 15 --insecure --retry 10"
CURRENT_VER="$(curl ${CURL_ARGS} http://${APP_NAME}:8073/VER | jq --raw-output '(.maj|tostring) + (.min|tostring)')"
REMOTE_VER="$(curl ${CURL_ARGS} --resolve raw.githubusercontent.com:443:${GITHUB_RWA_IP} https://raw.githubusercontent.com/flydog-sdr/FlyDog_SDR_GPS/master/Makefile | head -2 | cut -d " " -f3 | tr -d "\n")"
SCRIPTS_FETCH_URL="https://codeload.github.com/flydog-sdr/customised-scripts/zip/master"

# Version comparison
if [ ${CURRENT_VER} -ne ${REMOTE_VER} ]; then
    echo "New version detected, will now fetch deployment scripts and upgrade."
else
    echo "Already the latest version, exiting."
    exit 0
fi

# Fetch deployment scripts
if [ ! -f "/tmp/customised-scripts" ];then
    curl ${CURL_ARGS} --resolve codeload.github.com:443:${GITHUB_CODELOAD_IP} ${SCRIPTS_FETCH_URL} | busybox unzip - -d /tmp
    mv -f /tmp/customised-scripts-master /tmp/customised-scripts
    chmod -R 755 /tmp/customised-scripts
else
    rm -rf /tmp/customised-scripts
    curl ${CURL_ARGS} --resolve codeload.github.com:443:${GITHUB_CODELOAD_IP} ${SCRIPTS_FETCH_URL} | busybox unzip - -d /tmp
    mv -f /tmp/customised-scripts-master /tmp/customised-scripts
    chmod -R 755 /tmp/customised-scripts
fi

# Execute deployment scripts
bash -c /tmp/customised-scripts/deploy.sh

# Purge previous image for saving disk space
echo "Purging all unused or dangling images, containers."
docker container prune -f
docker image prune -f

# Self-update check
if [ ${SCRIPT_ID} = $(cat /tmp/customised-scripts/self-update.txt | sed -n '4p'| cut -d "=" -f2) ]; then
    echo "Upgrade finished!"
else
    cat /tmp/customised-scripts/self-update.txt > /usr/bin/updater.sh
    echo "Upgrade finished!"
fi
rm -rf /tmp/customised-scripts
exit 0
