#!/bin/bash

# SCRIPT_ID variable for self-update
SCRIPT_ID=3da85fea

# check if Auto-update is enabled
if [ $(cat /etc/kiwi.config/_UPDATE) -eq 1 ]; then
    echo "Auto-update is enabled, will now check for update."
else
    echo "Auto-update is disabled, exiting."
    exit 0
fi

# Check internet connectivity
NETWORK_CHECK_URL="baidu.com"
NETWORK_CHECK_RESPONSE="200"
if [ $(curl -I -s --connect-timeout 60 --retry 30 ${NETWORK_CHECK_URL} -w %{http_code} | tail -n1) -eq ${NETWORK_CHECK_RESPONSE} ]; then
    echo "Internet connected, continue."
else
    echo "Internet not connected, exiting."
    exit 1
fi

# Define global environment variables
APP_NAME="flydog-sdr"
CURL_ARGS="-L -s --connect-timeout 60 --insecure --retry 30"
CURRENT_VER="$(curl ${CURL_ARGS} http://${APP_NAME}:8073/VER | jq --raw-output '(.maj|tostring) + (.min|tostring)')"
REMOTE_VER="$(curl ${CURL_ARGS} https://bclswl0827.coding.net/p/flydog-sdr/d/api/git/raw/master/VER)"
SCRIPTS_FETCH_URL="https://bclswl0827.coding.net/p/flydog-sdr/d/api/git/archive/master"
IMAGE_TAG="registry.cn-shanghai.aliyuncs.com/flydog-sdr/flydog-sdr:latest"
LOCAL_IMAGE_ID=$(docker inspect -f {{".Id"}} ${IMAGE_TAG})

# Version comparison
if [ ${CURRENT_VER} -ne ${REMOTE_VER} ]; then
    echo "New version detected, will now fetch deployment scripts and upgrade."
else
    echo "Already the latest version, exiting."
    exit 0
fi

# Fetch deployment scripts
if [ ! -f "/tmp/customised-scripts" ];then
    curl ${CURL_ARGS} ${SCRIPTS_FETCH_URL} | busybox unzip - -d /tmp
    mv -f /tmp/bclswl0827-flydog-sdr-api-master /tmp/customised-scripts
    chmod -R 755 /tmp/customised-scripts
else
    rm -rf /tmp/customised-scripts
    curl ${CURL_ARGS} ${SCRIPTS_FETCH_URL} | busybox unzip - -d /tmp
    mv -f /tmp/bclswl0827-flydog-sdr-api-master /tmp/customised-scripts
    chmod -R 755 /tmp/customised-scripts
fi

# Execute deployment scripts
bash -c "IMAGE_TAG=${IMAGE_TAG} LOCAL_IMAGE_ID=${LOCAL_IMAGE_ID} /tmp/customised-scripts/deploy.sh"
